#!/bin/bash

set -e

if [ -n "$APP_PORT" ]
then
	echo "Configuring Kafka Connect with APP_PORT: $APP_PORT"
	DOCKER_MIRROR_HOST=$(/sbin/ip route|awk '/default/ { print $3 }')
	DOCKER_MIRROR_PORT=${MIRROR_PORT:-9001}
	DOCKER_MIRROR="http://$DOCKER_MIRROR_HOST:$DOCKER_MIRROR_PORT"

	export HOST_IP=$(curl $DOCKER_MIRROR/hostip)
	export HOST_PORT=$(curl $DOCKER_MIRROR/container/$HOSTNAME/port/$APP_PORT)
	export CONNECT_REST_ADVERTISED_HOST_NAME=$HOST_IP
	export CONNECT_REST_ADVERTISED_PORT=$HOST_PORT
else
	export CONNECT_REST_ADVERTISED_HOST_NAME=$APP_HOST
	export CONNECT_REST_ADVERTISED_PORT=8083
fi

echo "CONNECT_REST_ADVERTISED_HOST_NAME: $CONNECT_REST_ADVERTISED_HOST_NAME"
echo "CONNECT_REST_ADVERTISED_PORT: $CONNECT_REST_ADVERTISED_PORT"
exec "$@"
