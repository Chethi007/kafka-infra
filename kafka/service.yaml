---
AWSTemplateFormatVersion: '2010-09-09'

Description: Creates an ECS Kafka Service and Task

Parameters:
  Cluster:
    Description: ECS Cluster
    Type: String
  StackName:
    Description: The Parent Stack Name
    Type: String
  ServiceCpu:
    Description: CPU (1024 = 1 core)
    Type: Number
    Default: 896
  ServiceMemory:
    Description: Memory
    Type: Number
    Default: 4096
  JmxtransCpu:
    Description: CPU (1024 = 1 core)
    Type: Number
    Default: 128
  JmxtransMemory:
    Description: Memory
    Type: Number
    Default: 512
  DataVolumeMountPath:
    Description: Path to directory for mounting data
    Type: String
    MinLength: 1
    ConstraintDescription: Must be a valid folder path
  BrokerId:
    Description: Broker Id
    Type: Number
  BrokerName:
    Description: The name of the broker. Used to register a dns entry in route53
    Type: String
  DomainName:
    Description: The domain under which the broker will register its advertised address. (HostedZoneName)
    Type: String
  ZookeeperConnectionString:
    Description: Connection string for Zookeeper Cluster
    Type: String
  ZookeeperSecurityGroup:
    Description: Security Group to allow access to ZK
    Type: String
  ClientPort:
    Description: Kafka client port
    Type: Number
    Default: 9092
  ClientSSLPort:
    Description: Kafka client SSL port
    Type: Number
    Default: 9093
  JMXPort:
    Description: JMX Port to expose metrics on
    Type: Number
    Default: 8989
  LogGroup:
    Description: Log Group
    Type: String
  SecurityGroup:
    Description: Security Group
    Type: AWS::EC2::SecurityGroup::Id
  SubnetId:
    Description: SubnetId
    Type: AWS::EC2::Subnet::Id
  KafkaKeyPass:
    Description: Password for the kafka keystore
    Type: String
    NoEcho: true
    Default: ''
  KafkaTrustPass:
    Description: Password for the kafka keystore
    Type: String
    NoEcho: true
    Default: ''

Resources:
  BrokerNodeTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      NetworkMode: awsvpc
      ContainerDefinitions:
      - Name: broker
        Image: loyaltyone/cp-kafka:0.11-beta
        Cpu: !Ref 'ServiceCpu'
        MemoryReservation: !Ref 'ServiceMemory'
        User: root
        DockerLabels:
          'discovery.service.name': !Sub '${BrokerName}${BrokerId}'
        Environment:
          - Name: KAFKA_BROKER_ID
            Value: !Ref 'BrokerId'
          - Name: KAFKA_ZOOKEEPER_CONNECT
            Value: !Ref 'ZookeeperConnectionString'
          - Name: KAFKA_ADVERTISED_LISTENERS
            Value: !Sub 'SSL://${BrokerName}${BrokerId}.${DomainName}:${ClientSSLPort},PLAINTEXT://${BrokerName}${BrokerId}.${DomainName}:${ClientPort}'
          - Name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
            Value: 2
          - Name: KAFKA_JMX_HOSTNAME
            Value: 'localhost'
          - Name: KAFKA_JMX_PORT
            Value: !Ref 'JMXPort'
          - Name: KAFKA_LOG4J_LOGGERS
            Value: 'kafka.controller=WARN,state.change.logger=WARN'
          - Name: KAFKA_SSL_DIR
            Value: '/var/private/ssl'
          - Name: KAFKA_SSL_KEYSTORE_LOCATION
            Value: '/var/private/ssl/kafka.keystore.jks'
          - Name: KAFKA_SSL_KEYSTORE_FILENAME
            Value: 'kafka.keystore.jks'
          - Name: KAFKA_SSL_KEYSTORE_PASSWORD
            Value: !Ref 'KafkaKeyPass'
          - Name: KAFKA_SSL_KEY_PASSWORD
            Value: !Ref 'KafkaKeyPass'
          - Name: KAFKA_SSL_KEY_CREDENTIALS
            Value: 'broker_sslkey_creds'
          - Name: KAFKA_SSL_KEYSTORE_CREDENTIALS
            Value: 'broker_keystore_creds'
          - Name: KAFKA_SSL_TRUSTSTORE_CREDENTIALS
            Value: 'broker_truststore_creds'
          - Name: KAFKA_SSL_TRUSTSTORE_LOCATION
            Value: '/var/private/ssl/kafka.truststore.jks'
          - Name: KAFKA_SSL_TRUSTSTORE_FILENAME
            Value: 'kafka.truststore.jks'
          - Name: KAFKA_SSL_TRUSTSTORE_PASSWORD
            Value: !Ref 'KafkaTrustPass'
          - Name: KAFKA_SECURITY_INTER_BROKER_PROTOCOL
            Value: 'SSL'
          - Name: KAFKA_SSL_CLIENT_AUTH
            Value: 'required'
          - Name: DUMMY_VARIABLE
            Value: 'blah'
          - Name: KAFKA_LOG4J_LOGGERS
            Value: 'kafka.network.RequestChannel=DEBUG'
          - Name: KAFKA_LOG4J_ROOT_LOGLEVEL
            Value: 'DEBUG'
          - Name: KAFKA_TOOLS_LOG4J_LOGLEVEL
            Value: 'DEBUG'
        PortMappings:
          - ContainerPort: !Ref 'ClientPort'
            HostPort: !Ref 'ClientPort'
          - ContainerPort: !Ref 'ClientSSLPort'
            HostPort: !Ref 'ClientSSLPort'
          - ContainerPort: !Ref 'JMXPort'
            HostPort: !Ref 'JMXPort'
        MountPoints:
          - SourceVolume: data
            ContainerPath: /var/lib/kafka/data
          - SourceVolume: secrets
            ContainerPath: /etc/kafka/secrets
          - SourceVolume: ssl
            ContainerPath: /var/private/ssl
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref 'LogGroup'
            awslogs-region: !Ref 'AWS::Region'
            awslogs-stream-prefix: !Sub 'broker${BrokerId}'
      - Name: jmxtrans
        Image: loyaltyone/jmxtrans:0.1-beta
        Cpu: !Ref 'JmxtransCpu'
        MemoryReservation: !Ref 'JmxtransMemory'
        Environment:
          - Name: SECONDS_BETWEEN_RUNS
            Value: 60
          - Name: JMXTRANS_ENV
            Value: aws
          - Name: JMXTRANS_HOSTS
            Value: !Sub 'kafka#localhost:${JMXPort}'
          - Name: JMXTRANS_ALIASES
            Value: !Sub '${BrokerName}${BrokerId}.${DomainName}'
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref 'LogGroup'
            awslogs-region: !Ref 'AWS::Region'
            awslogs-stream-prefix: !Sub 'broker${BrokerId}'
      Volumes:
        # It's probably not a good idea to change these mounts and deploy against a live
        # cluster in production.
        - Name: data
          Host:
            SourcePath: !Sub '${DataVolumeMountPath}/broker/${BrokerId}/data'
        - Name: secrets
          Host:
            SourcePath: !Sub '${DataVolumeMountPath}/broker/${BrokerId}/secrets'
        - Name: ssl
          Host:
            SourcePath: !Sub '${DataVolumeMountPath}/ssl'
      Family: !Sub '${StackName}-broker-${BrokerId}'
  BrokerNodeService:
    Type: 'AWS::ECS::Service'
    Properties:
      ServiceName: !Sub '${StackName}-broker-${BrokerId}'
      Cluster: !Ref 'Cluster'
      DesiredCount: 1
      TaskDefinition: !Ref 'BrokerNodeTaskDefinition'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
             - !Ref 'SecurityGroup'
             - !Ref 'ZookeeperSecurityGroup'
          Subnets:
             - !Ref 'SubnetId'
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0

Outputs:
  ConnectionString:
    Description: The connection string for this broker
    Value: !Sub '${BrokerName}${BrokerId}.${DomainName}:${ClientPort}'
  SSLConnectionString:
    Description: The connection string for this broker
    Value: !Sub '${BrokerName}${BrokerId}.${DomainName}:${ClientSSLPort}'
